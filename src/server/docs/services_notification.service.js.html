<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>services/notification.service.js - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="AdminController.html">AdminController</a></li><li><a href="AdminModel.html">AdminModel</a></li><li><a href="AdminService.html">AdminService</a></li><li><a href="AulaController.html">AulaController</a></li><li><a href="AulaModel.html">AulaModel</a></li><li><a href="AulaService.html">AulaService</a></li><li><a href="CoordinadorController.html">CoordinadorController</a></li><li><a href="CoordinadorService.html">CoordinadorService</a></li><li><a href="CurricularController.html">CurricularController</a></li><li><a href="CurricularModel.html">CurricularModel</a></li><li><a href="CurricularService.html">CurricularService</a></li><li><a href="DocumentServices.html">DocumentServices</a><ul class='methods'><li data-type='method'><a href="DocumentServices.html#.crearCeldaEstilizada">crearCeldaEstilizada</a></li><li data-type='method'><a href="DocumentServices.html#.crearDocumentoHorario">crearDocumentoHorario</a></li><li data-type='method'><a href="DocumentServices.html#.crearFilaInformacion">crearFilaInformacion</a></li><li data-type='method'><a href="DocumentServices.html#.crearFilasTabla">crearFilasTabla</a></li><li data-type='method'><a href="DocumentServices.html#.crearParrafoEstilizado">crearParrafoEstilizado</a></li><li data-type='method'><a href="DocumentServices.html#.crearTextoEstilizado">crearTextoEstilizado</a></li><li data-type='method'><a href="DocumentServices.html#.generarDocumentoHorario">generarDocumentoHorario</a></li><li data-type='method'><a href="DocumentServices.html#.generarHorasDisponibles">generarHorasDisponibles</a></li><li data-type='method'><a href="DocumentServices.html#.procesarHorario">procesarHorario</a></li><li data-type='method'><a href="DocumentServices.html#.traerLogoMarcaAgua">traerLogoMarcaAgua</a></li></ul></li><li><a href="EmailService.html">EmailService</a></li><li><a href="FormatterResponseController.html">FormatterResponseController</a></li><li><a href="FormatterResponseModel.html">FormatterResponseModel</a></li><li><a href="FormatterResponseService.html">FormatterResponseService</a></li><li><a href="HorarioController.html">HorarioController</a></li><li><a href="HorarioService.html">HorarioService</a></li><li><a href="NotificationController.html">NotificationController</a></li><li><a href="ProfesorController.html">ProfesorController</a></li><li><a href="ProfesorModel.html">ProfesorModel</a></li><li><a href="ProfesorService.html">ProfesorService</a></li><li><a href="SedeController.html">SedeController</a></li><li><a href="SedeModel.html">SedeModel</a></li><li><a href="SedeService.html">SedeService</a></li><li><a href="SystemController.html">SystemController</a></li><li><a href="SystemModel.html">SystemModel</a></li><li><a href="UserController.html">UserController</a></li><li><a href="UserModel.html">UserModel</a></li><li><a href="UserService.html">UserService</a></li><li><a href="ValidationService.html">ValidationService</a></li><li><a href="module.exports_module.exports.html">exports</a></li></ul><h3>Modules</h3><ul><li><a href="module-CoordinadorModel.html">CoordinadorModel</a><ul class='methods'><li data-type='method'><a href="module-CoordinadorModel.html#.actualizarCoordinador">actualizarCoordinador</a></li><li data-type='method'><a href="module-CoordinadorModel.html#.asignarCoordinador">asignarCoordinador</a></li><li data-type='method'><a href="module-CoordinadorModel.html#.destituirCoordinador">destituirCoordinador</a></li><li data-type='method'><a href="module-CoordinadorModel.html#.obtenerCoordinador">obtenerCoordinador</a></li><li data-type='method'><a href="module-CoordinadorModel.html#.obtenerCoordinadorPorId">obtenerCoordinadorPorId</a></li><li data-type='method'><a href="module-CoordinadorModel.html#.obtenerCoordinadorPorPnf">obtenerCoordinadorPorPnf</a></li><li data-type='method'><a href="module-CoordinadorModel.html#.obtenerCoordinadoresActivos">obtenerCoordinadoresActivos</a></li><li data-type='method'><a href="module-CoordinadorModel.html#.obtenerDatosCoordinadorCompletos">obtenerDatosCoordinadorCompletos</a></li><li data-type='method'><a href="module-CoordinadorModel.html#.obtenerHistorialCoordinador">obtenerHistorialCoordinador</a></li><li data-type='method'><a href="module-CoordinadorModel.html#.obtenerHistorialDestituciones">obtenerHistorialDestituciones</a></li><li data-type='method'><a href="module-CoordinadorModel.html#.obtenerTodos">obtenerTodos</a></li><li data-type='method'><a href="module-CoordinadorModel.html#.reasignarCoordinador">reasignarCoordinador</a></li><li data-type='method'><a href="module-CoordinadorModel.html#.restituirCoordinador">restituirCoordinador</a></li><li data-type='method'><a href="module-CoordinadorModel.html#.validarCoordinadorActivo">validarCoordinadorActivo</a></li></ul></li><li><a href="module-CurricularRouter.html">CurricularRouter</a></li><li><a href="module-passwordUtils.html">passwordUtils</a><ul class='methods'><li data-type='method'><a href="module-passwordUtils.html#~comparePassword">comparePassword</a></li><li data-type='method'><a href="module-passwordUtils.html#~generarPassword">generarPassword</a></li><li data-type='method'><a href="module-passwordUtils.html#~hashPassword">hashPassword</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html">CrearSecciones</a></li><li><a href="global.html#DELETE/admins/:id">DELETE /admins/:id</a></li><li><a href="global.html#DELETE/aulas/:id">DELETE /aulas/:id</a></li><li><a href="global.html#DELETE/coordinadores/:id/destituir">DELETE /coordinadores/:id/destituir</a></li><li><a href="global.html#DELETE/horarios/:id">DELETE /horarios/:id</a></li><li><a href="global.html#DELETE/profesores/:id">DELETE /profesores/:id</a></li><li><a href="global.html#DELETE/profesores/:id_profesor/disponibilidad/:id_disponibilidad">DELETE /profesores/:id_profesor/disponibilidad/:id_disponibilidad</a></li><li><a href="global.html#DELETE/sedes/:id">DELETE /sedes/:id</a></li><li><a href="global.html#DELETE/system/backups/:backupFileName">DELETE /system/backups/:backupFileName</a></li><li><a href="global.html#DELETE/system/backups/cleanup">DELETE /system/backups/cleanup</a></li><li><a href="global.html#DELETE/user/:id_usuario/desactivar">DELETE /user/:id_usuario/desactivar</a></li><li><a href="global.html#EMAIL_CONFIG">EMAIL_CONFIG</a></li><li><a href="global.html#EnviarTokenEmail">EnviarTokenEmail</a></li><li><a href="global.html#GET/admin/logs">GET /admin/logs</a></li><li><a href="global.html#GET/admin/profile">GET /admin/profile</a></li><li><a href="global.html#GET/admin/reports">GET /admin/reports</a></li><li><a href="global.html#GET/admin/stats">GET /admin/stats</a></li><li><a href="global.html#GET/admins">GET /admins</a></li><li><a href="global.html#GET/admins/search">GET /admins/search</a></li><li><a href="global.html#GET/api/aulas">GET /api/aulas</a></li><li><a href="global.html#GET/api/profesores">GET /api/profesores</a></li><li><a href="global.html#GET/api/system/backups">GET /api/system/backups</a></li><li><a href="global.html#GET/api/system/estadisticas">GET /api/system/estadisticas</a></li><li><a href="global.html#GET/api/system/metricas">GET /api/system/metricas</a></li><li><a href="global.html#GET/api/system/status">GET /api/system/status</a></li><li><a href="global.html#GET/auditory/system">GET /auditory/system</a></li><li><a href="global.html#GET/aulas">GET /aulas</a></li><li><a href="global.html#GET/aulas/:id">GET /aulas/:id</a></li><li><a href="global.html#GET/aulas/pnf/:codigoPNF">GET /aulas/pnf/:codigoPNF</a></li><li><a href="global.html#GET/aulas/sede/:sede">GET /aulas/sede/:sede</a></li><li><a href="global.html#GET/aulas/tipo/:tipo">GET /aulas/tipo/:tipo</a></li><li><a href="global.html#GET/auth/verify">GET /auth/verify</a></li><li><a href="global.html#GET/catalogos/areas-conocimiento">GET /catalogos/areas-conocimiento</a></li><li><a href="global.html#GET/catalogos/posgrados">GET /catalogos/posgrados</a></li><li><a href="global.html#GET/catalogos/pregrados">GET /catalogos/pregrados</a></li><li><a href="global.html#GET/coordinadores">GET /coordinadores</a></li><li><a href="global.html#GET/coordinadores/:id">GET /coordinadores/:id</a></li><li><a href="global.html#GET/coordinadores/:id/historial-destituciones">GET /coordinadores/:id/historial-destituciones</a></li><li><a href="global.html#GET/coordinadores/destituidos">GET /coordinadores/destituidos</a></li><li><a href="global.html#GET/exportar/seccion/:id_seccion">GET /exportar/seccion/:id_seccion</a></li><li><a href="global.html#GET/horarios/aula/:id_aula">GET /horarios/aula/:id_aula</a></li><li><a href="global.html#GET/horarios/profesor/:id_profesor">GET /horarios/profesor/:id_profesor</a></li><li><a href="global.html#GET/horarios/seccion/:id_seccion">GET /horarios/seccion/:id_seccion</a></li><li><a href="global.html#GET/notifications">GET /notifications</a></li><li><a href="global.html#GET/profesores">GET /profesores</a></li><li><a href="global.html#GET/profesores/:id">GET /profesores/:id</a></li><li><a href="global.html#GET/profesores/:id/imagen">GET /profesores/:id/imagen</a></li><li><a href="global.html#GET/profesores/search">GET /profesores/search</a></li><li><a href="global.html#GET/profile">GET /profile</a></li><li><a href="global.html#GET/sedes">GET /sedes</a></li><li><a href="global.html#GET/sedes/:id">GET /sedes/:id</a></li><li><a href="global.html#GET/system/backups">GET /system/backups</a></li><li><a href="global.html#GET/system/backups/download/:backupFileName">GET /system/backups/download/:backupFileName</a></li><li><a href="global.html#GET/system/estado">GET /system/estado</a></li><li><a href="global.html#GET/system/info">GET /system/info</a></li><li><a href="global.html#GET/system/logs">GET /system/logs</a></li><li><a href="global.html#GET/system/mapa-calor/horarios">GET /system/mapa-calor/horarios</a></li><li><a href="global.html#GET/system/metricas/academicas">GET /system/metricas/academicas</a></li><li><a href="global.html#GET/system/metricas/sistema">GET /system/metricas/sistema</a></li><li><a href="global.html#GET/system/reportes/estadisticas">GET /system/reportes/estadisticas</a></li><li><a href="global.html">GuardarTokenEmail</a></li><li><a href="global.html#PATCH/admins/:id/rol">PATCH /admins/:id/rol</a></li><li><a href="global.html#POST/admins">POST /admins</a></li><li><a href="global.html#POST/aulas">POST /aulas</a></li><li><a href="global.html#POST/aulas/to/horarios">POST /aulas/to/horarios</a></li><li><a href="global.html#POST/auth/login">POST /auth/login</a></li><li><a href="global.html#POST/catalogos/areas-conocimiento">POST /catalogos/areas-conocimiento</a></li><li><a href="global.html#POST/catalogos/posgrados">POST /catalogos/posgrados</a></li><li><a href="global.html#POST/catalogos/pregrados">POST /catalogos/pregrados</a></li><li><a href="global.html#POST/coordinadores">POST /coordinadores</a></li><li><a href="global.html#POST/coordinadores/:id/restitur">POST /coordinadores/:id/restitur</a></li><li><a href="global.html#POST/horarios">POST /horarios</a></li><li><a href="global.html#POST/profesores">POST /profesores</a></li><li><a href="global.html#POST/profesores/:id/disponibilidad">POST /profesores/:id/disponibilidad</a></li><li><a href="global.html#POST/profesores/:id/reingresar">POST /profesores/:id/reingresar</a></li><li><a href="global.html#POST/profesores/to/seccion/:id_seccion">POST /profesores/to/seccion/:id_seccion</a></li><li><a href="global.html#POST/sedes">POST /sedes</a></li><li><a href="global.html#POST/system/backup">POST /system/backup</a></li><li><a href="global.html#POST/system/backup/manual">POST /system/backup/manual</a></li><li><a href="global.html#POST/system/restore">POST /system/restore</a></li><li><a href="global.html#PUT/admin/profile">PUT /admin/profile</a></li><li><a href="global.html#PUT/admins/:id">PUT /admins/:id</a></li><li><a href="global.html#PUT/aulas/:id">PUT /aulas/:id</a></li><li><a href="global.html#PUT/auth/password">PUT /auth/password</a></li><li><a href="global.html#PUT/coordinadores/:cedula/reasignar-pnf">PUT /coordinadores/:cedula/reasignar-pnf</a></li><li><a href="global.html#PUT/coordinadores/:id">PUT /coordinadores/:id</a></li><li><a href="global.html#PUT/horarios/:id">PUT /horarios/:id</a></li><li><a href="global.html#PUT/profesores/:id">PUT /profesores/:id</a></li><li><a href="global.html#PUT/profesores/:id_profesor/disponibilidad">PUT /profesores/:id_profesor/disponibilidad</a></li><li><a href="global.html#PUT/sedes/:id">PUT /sedes/:id</a></li><li><a href="global.html#PUT/user/:id_usuario/activar">PUT /user/:id_usuario/activar</a></li><li><a href="global.html">VerificarToken</a></li><li><a href="global.html">activar</a></li><li><a href="global.html">activarUsuario</a></li><li><a href="global.html">actualizar</a></li><li><a href="global.html">actualizarAdmin</a></li><li><a href="global.html">actualizarAula</a></li><li><a href="global.html">actualizarContrase√±aYLimpiarToken</a></li><li><a href="global.html">actualizarCoordinador</a></li><li><a href="global.html">actualizarDescripcionTrayecto</a></li><li><a href="global.html">actualizarDisponibilidad</a></li><li><a href="global.html#actualizarHorario">actualizarHorario</a></li><li><a href="global.html">actualizarPNF</a></li><li><a href="global.html">actualizarPerfil</a></li><li><a href="global.html#actualizarProfesor">actualizarProfesor</a></li><li><a href="global.html">actualizarSede</a></li><li><a href="global.html">actualizarUltimoAcceso</a></li><li><a href="global.html">actualizarUnidadCurricular</a></li><li><a href="global.html#agregarRolDestinatario">agregarRolDestinatario</a></li><li><a href="global.html#agregarUsuarioDestinatario">agregarUsuarioDestinatario</a></li><li><a href="global.html#asegurarStringEnMinusculas">asegurarStringEnMinusculas</a></li><li><a href="global.html">asignacionTurnoSeccion</a></li><li><a href="global.html">asignarCoordinador</a></li><li><a href="global.html">asignarTurnoSeccion</a></li><li><a href="global.html">buscar</a></li><li><a href="global.html">buscarAdmin</a></li><li><a href="global.html">buscarPorEmail</a></li><li><a href="global.html">buscarPorId</a></li><li><a href="global.html#buscarProfesor">buscarProfesor</a></li><li><a href="global.html">cambiarContrase√±a</a></li><li><a href="global.html">cambiarRol</a></li><li><a href="global.html">cambiarRolAdmin</a></li><li><a href="global.html">cerrarSesion</a></li><li><a href="global.html#closeSession">closeSession</a></li><li><a href="global.html">conflict</a></li><li><a href="global.html#connectDB">connectDB</a></li><li><a href="global.html">contarPorRolYEstado</a></li><li><a href="global.html#corsOptions">corsOptions</a></li><li><a href="global.html">crear</a></li><li><a href="global.html">crearAreaConocimiento</a></li><li><a href="global.html">crearDisponibilidad</a></li><li><a href="global.html#crearNotificacionCompleta">crearNotificacionCompleta</a></li><li><a href="global.html#crearNotificacionIndividual">crearNotificacionIndividual</a></li><li><a href="global.html#crearNotificacionMasiva">crearNotificacionMasiva</a></li><li><a href="global.html">crearPosgrado</a></li><li><a href="global.html">crearPregrado</a></li><li><a href="global.html">crearRespaldo</a></li><li><a href="global.html">crearSecciones</a></li><li><a href="global.html#crearSede">crearSede</a></li><li><a href="global.html#createValidationResponse">createValidationResponse</a></li><li><a href="global.html">created</a></li><li><a href="global.html">desactivar</a></li><li><a href="global.html">desactivarAdmin</a></li><li><a href="global.html">desactivarUsuario</a></li><li><a href="global.html#descargarRespaldo">descargarRespaldo</a></li><li><a href="global.html#destituirProfesor">destituirProfesor</a></li><li><a href="global.html#disconnectDB">disconnectDB</a></li><li><a href="global.html">eliminar</a></li><li><a href="global.html">eliminarAula</a></li><li><a href="global.html">eliminarCoordinador</a></li><li><a href="global.html">eliminarDisponibilidad</a></li><li><a href="global.html#eliminarHorario">eliminarHorario</a></li><li><a href="global.html">eliminarPnf</a></li><li><a href="global.html">eliminarRespaldo</a></li><li><a href="global.html">eliminarSede</a></li><li><a href="global.html">eliminarUnidadCurricular</a></li><li><a href="global.html#enviarEmail">enviarEmail</a></li><li><a href="global.html#enviarEmailMultiple">enviarEmailMultiple</a></li><li><a href="global.html">error</a></li><li><a href="global.html#exportarHorarioWord">exportarHorarioWord</a></li><li><a href="global.html">extractData</a></li><li><a href="global.html">extractError</a></li><li><a href="global.html">filtrarPorEstado</a></li><li><a href="global.html">filtrarPorRol</a></li><li><a href="global.html">filtrarPorSede</a></li><li><a href="global.html">filtrarPorTipo</a></li><li><a href="global.html">forbidden</a></li><li><a href="global.html">formatValidationErrors</a></li><li><a href="global.html">fromDatabaseResponse</a></li><li><a href="global.html#generarDocumentoHorario">generarDocumentoHorario</a></li><li><a href="global.html#generateEmailTemplate">generateEmailTemplate</a></li><li><a href="global.html#get/auth/logout">get /auth/logout</a></li><li><a href="global.html#getCookie">getCookie</a></li><li><a href="global.html">getDefaultTitle</a></li><li><a href="global.html">getErrorCode</a></li><li><a href="global.html#getFilterCondition">getFilterCondition</a></li><li><a href="global.html#getImageProfesorDirect">getImageProfesorDirect</a></li><li><a href="global.html">getMinimalFallback</a></li><li><a href="global.html">getProfile</a></li><li><a href="global.html">getTranslation</a></li><li><a href="global.html">isError</a></li><li><a href="global.html">isSuccess</a></li><li><a href="global.html#joinRoleRooms">joinRoleRooms</a></li><li><a href="global.html#jsonSyntaxErrorHandler">jsonSyntaxErrorHandler</a></li><li><a href="global.html">limpiarRespaldosAntiguos</a></li><li><a href="global.html">listarCoordinadores</a></li><li><a href="global.html">listarCoordinadoresDestituidos</a></li><li><a href="global.html">listarRespaldos</a></li><li><a href="global.html#listenNotifications">listenNotifications</a></li><li><a href="global.html#loadEnv">loadEnv</a></li><li><a href="global.html">login</a></li><li><a href="global.html">loginUser</a></li><li><a href="global.html">manejarServicio</a></li><li><a href="global.html">marcarComoLeida</a></li><li><a href="global.html#markAsRead">markAsRead</a></li><li><a href="global.html#middlewareAuth">middlewareAuth</a></li><li><a href="global.html">mostrarAdmin</a></li><li><a href="global.html#mostrarAreasConocimiento">mostrarAreasConocimiento</a></li><li><a href="global.html#mostrarAulaCambiarHorario">mostrarAulaCambiarHorario</a></li><li><a href="global.html">mostrarAulas</a></li><li><a href="global.html#mostrarAulasParaHorario">mostrarAulasParaHorario</a></li><li><a href="global.html">mostrarDisponibilidad</a></li><li><a href="global.html#mostrarHorariosPorAula">mostrarHorariosPorAula</a></li><li><a href="global.html#mostrarHorariosPorSeccion">mostrarHorariosPorSeccion</a></li><li><a href="global.html#mostrarHorariosProfesores">mostrarHorariosProfesores</a></li><li><a href="global.html">mostrarLineasInvestigacion</a></li><li><a href="global.html">mostrarNotificacion</a></li><li><a href="global.html">mostrarPNF</a></li><li><a href="global.html#mostrarPosGrados">mostrarPosGrados</a></li><li><a href="global.html#mostrarPreGrados">mostrarPreGrados</a></li><li><a href="global.html#mostrarProfesor">mostrarProfesor</a></li><li><a href="global.html#mostrarProfesorAPI">mostrarProfesorAPI</a></li><li><a href="global.html#mostrarProfesorCambiarHorario">mostrarProfesorCambiarHorario</a></li><li><a href="global.html">mostrarProfesoresEliminados</a></li><li><a href="global.html#mostrarProfesoresParaHorario">mostrarProfesoresParaHorario</a></li><li><a href="global.html">mostrarSecciones</a></li><li><a href="global.html">mostrarSeccionesByPnfAndValueTrayecto</a></li><li><a href="global.html">mostrarSeccionesByPnfAndValueUnidadCurricular</a></li><li><a href="global.html">mostrarSedes</a></li><li><a href="global.html">mostrarTrayectos</a></li><li><a href="global.html">mostrarTurnos</a></li><li><a href="global.html">mostrarUnidadesCurriculares</a></li><li><a href="global.html">notFound</a></li><li><a href="global.html">obtenerAdminPorId</a></li><li><a href="global.html">obtenerAdminsPorEstado</a></li><li><a href="global.html">obtenerAdminsPorRol</a></li><li><a href="global.html">obtenerAreasConocimiento</a></li><li><a href="global.html#obtenerAuditoria">obtenerAuditoria</a></li><li><a href="global.html">obtenerAuditoriaCompleta</a></li><li><a href="global.html">obtenerAulaPorId</a></li><li><a href="global.html">obtenerAulasDisponibles</a></li><li><a href="global.html">obtenerAulasPorPnf</a></li><li><a href="global.html">obtenerAulasPorSede</a></li><li><a href="global.html">obtenerAulasPorTipo</a></li><li><a href="global.html">obtenerConFiltros</a></li><li><a href="global.html">obtenerCoordinador</a></li><li><a href="global.html">obtenerEstadoSistema</a></li><li><a href="global.html">obtenerHistorialDestituciones</a></li><li><a href="global.html#obtenerHorariosPorAula">obtenerHorariosPorAula</a></li><li><a href="global.html#obtenerHorariosPorProfesor">obtenerHorariosPorProfesor</a></li><li><a href="global.html#obtenerHorariosPorSeccion">obtenerHorariosPorSeccion</a></li><li><a href="global.html#obtenerIdUSerProfesor">obtenerIdUSerProfesor</a></li><li><a href="global.html">obtenerImagen</a></li><li><a href="global.html#obtenerInformacionSistema">obtenerInformacionSistema</a></li><li><a href="global.html#obtenerLogsSistema">obtenerLogsSistema</a></li><li><a href="global.html">obtenerMapaCalorHorarios</a></li><li><a href="global.html#obtenerMapaCalorOcupacion">obtenerMapaCalorOcupacion</a></li><li><a href="global.html">obtenerMetricasAcademicas</a></li><li><a href="global.html">obtenerMetricasSistema</a></li><li><a href="global.html">obtenerPerfil</a></li><li><a href="global.html#obtenerPorAula">obtenerPorAula</a></li><li><a href="global.html#obtenerPorId">obtenerPorId</a></li><li><a href="global.html#obtenerPorProfesor">obtenerPorProfesor</a></li><li><a href="global.html#obtenerPorSeccion">obtenerPorSeccion</a></li><li><a href="global.html">obtenerPosgrados</a></li><li><a href="global.html">obtenerPregrados</a></li><li><a href="global.html#obtenerProfesoresDisponibles">obtenerProfesoresDisponibles</a></li><li><a href="global.html">obtenerReportesEstadisticas</a></li><li><a href="global.html">obtenerRolesDisponibles</a></li><li><a href="global.html">obtenerSedePorId</a></li><li><a href="global.html">obtenerTodas</a></li><li><a href="global.html">obtenerTodos</a></li><li><a href="global.html">obtenerUnidadCurricularPorId</a></li><li><a href="global.html">obtenerUsuarioPorEmail</a></li><li><a href="global.html">obtenerUsuarioPorEmailConToken</a></li><li><a href="global.html">obtenerUsuarioPorId</a></li><li><a href="global.html">paginated</a></li><li><a href="global.html#parseJSONField">parseJSONField</a></li><li><a href="global.html#post/auth/logout">post /auth/logout</a></li><li><a href="global.html">quitarRol</a></li><li><a href="global.html">reactivarPnf</a></li><li><a href="global.html">reasignarCoordinador</a></li><li><a href="global.html#registerAreaConocimiento">registerAreaConocimiento</a></li><li><a href="global.html#registerAula">registerAula</a></li><li><a href="global.html#registerPosGrado">registerPosGrado</a></li><li><a href="global.html#registerPreGrado">registerPreGrado</a></li><li><a href="global.html#registerSede">registerSede</a></li><li><a href="global.html">registrarAdmin</a></li><li><a href="global.html">registrarAula</a></li><li><a href="global.html#registrarHorario">registrarHorario</a></li><li><a href="global.html">registrarLineaInvestigacion</a></li><li><a href="global.html">registrarLineasInvestigacion</a></li><li><a href="global.html">registrarPNF</a></li><li><a href="global.html#registrarProfesor">registrarProfesor</a></li><li><a href="global.html">registrarSede</a></li><li><a href="global.html">registrarUnidadCurricular</a></li><li><a href="global.html#regitrarPNF">regitrarPNF</a></li><li><a href="global.html#regitrarUnidadCurricular">regitrarUnidadCurricular</a></li><li><a href="global.html">reingresar</a></li><li><a href="global.html">reingresoProfesor</a></li><li><a href="global.html#reportesEstadisticas">reportesEstadisticas</a></li><li><a href="global.html">respuestaDatos</a></li><li><a href="global.html">respuestaError</a></li><li><a href="global.html">respuestaExito</a></li><li><a href="global.html">respuestaPaginada</a></li><li><a href="global.html">respuestaPostgres</a></li><li><a href="global.html">respuestaServicio</a></li><li><a href="global.html">respuestaSuccess</a></li><li><a href="global.html">respuestaValidacionError</a></li><li><a href="global.html">restaurarRespaldo</a></li><li><a href="global.html">restituirCoordinador</a></li><li><a href="global.html#searchNotificationDestinatario">searchNotificationDestinatario</a></li><li><a href="global.html#searchNotificationGlobales">searchNotificationGlobales</a></li><li><a href="global.html#searchNotificationRoles">searchNotificationRoles</a></li><li><a href="global.html#searchNotificationUser">searchNotificationUser</a></li><li><a href="global.html#searchNotifications">searchNotifications</a></li><li><a href="global.html#securityMiddleware">securityMiddleware</a></li><li><a href="global.html#sendToGlobals">sendToGlobals</a></li><li><a href="global.html#sendToRoles">sendToRoles</a></li><li><a href="global.html#sendToUser">sendToUser</a></li><li><a href="global.html#socketAuth">socketAuth</a></li><li><a href="global.html#storage">storage</a></li><li><a href="global.html">success</a></li><li><a href="global.html">unauthorized</a></li><li><a href="global.html">updateProfile</a></li><li><a href="global.html">validacionesComunes</a></li><li><a href="global.html#validarFormatoEmail">validarFormatoEmail</a></li><li><a href="global.html#validateAdmins">validateAdmins</a></li><li><a href="global.html#validateAreaConocimiento">validateAreaConocimiento</a></li><li><a href="global.html#validateAsignacionCoordinador">validateAsignacionCoordinador</a></li><li><a href="global.html#validateAula">validateAula</a></li><li><a href="global.html#validateContrasenia">validateContrasenia</a></li><li><a href="global.html#validateCoordinador">validateCoordinador</a></li><li><a href="global.html">validateCreacionSecciones</a></li><li><a href="global.html#validateDestitucion">validateDestitucion</a></li><li><a href="global.html#validateDisponibilidadDocente">validateDisponibilidadDocente</a></li><li><a href="global.html#validateHorario">validateHorario</a></li><li><a href="global.html#validateId">validateId</a></li><li><a href="global.html#validateLineaInvestigacion">validateLineaInvestigacion</a></li><li><a href="global.html#validateLogin">validateLogin</a></li><li><a href="global.html">validateNuevaAreaConocimiento</a></li><li><a href="global.html">validateNuevoPosgrado</a></li><li><a href="global.html">validateNuevoPregrado</a></li><li><a href="global.html#validatePartialAdmins">validatePartialAdmins</a></li><li><a href="global.html#validatePartialAreaConocimiento">validatePartialAreaConocimiento</a></li><li><a href="global.html#validatePartialAula">validatePartialAula</a></li><li><a href="global.html#validatePartialCoordinador">validatePartialCoordinador</a></li><li><a href="global.html#validatePartialDestitucion">validatePartialDestitucion</a></li><li><a href="global.html#validatePartialDisponibilidadDocente">validatePartialDisponibilidadDocente</a></li><li><a href="global.html#validatePartialHorario">validatePartialHorario</a></li><li><a href="global.html#validatePartialLogin">validatePartialLogin</a></li><li><a href="global.html#validatePartialPnf">validatePartialPnf</a></li><li><a href="global.html#validatePartialPosgrado">validatePartialPosgrado</a></li><li><a href="global.html#validatePartialPregrado">validatePartialPregrado</a></li><li><a href="global.html#validatePartialProfesor">validatePartialProfesor</a></li><li><a href="global.html#validatePartialSeccion">validatePartialSeccion</a></li><li><a href="global.html#validatePartialSede">validatePartialSede</a></li><li><a href="global.html#validatePartialUnidadCurricular">validatePartialUnidadCurricular</a></li><li><a href="global.html#validatePartialUser">validatePartialUser</a></li><li><a href="global.html#validatePnf">validatePnf</a></li><li><a href="global.html#validatePosgrado">validatePosgrado</a></li><li><a href="global.html#validatePregrado">validatePregrado</a></li><li><a href="global.html#validateProfesor">validateProfesor</a></li><li><a href="global.html#validateQueryParams">validateQueryParams</a></li><li><a href="global.html#validateRecoveryPassword">validateRecoveryPassword</a></li><li><a href="global.html#validateReingreso">validateReingreso</a></li><li><a href="global.html#validateRequiredFields">validateRequiredFields</a></li><li><a href="global.html#validateSeccion">validateSeccion</a></li><li><a href="global.html#validateSede">validateSede</a></li><li><a href="global.html#validateUnidadCurricular">validateUnidadCurricular</a></li><li><a href="global.html#validateUser">validateUser</a></li><li><a href="global.html">validationError</a></li><li><a href="global.html#verificarConexion">verificarConexion</a></li><li><a href="global.html#verificarConexionInternet">verificarConexionInternet</a></li><li><a href="global.html#verificarDependencias">verificarDependencias</a></li><li><a href="global.html#verificarEmailConAPI">verificarEmailConAPI</a></li><li><a href="global.html">verificarSesion</a></li><li><a href="global.html#verificarUsers">verificarUsers</a></li><li><a href="global.html#verificarYValidarEmails">verificarYValidarEmails</a></li></ul>
    
</nav>

<div id="main">
    
    <h1 class="page-title">services/notification.service.js</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import pool from "../database/pg.js";
import SocketServices from "./socket.service.js";

export default class NotificationService {
  constructor() {
    this.socketService = SocketServices.getInstance();
    this.socketService.initializeService(); // Asegurar que est√© inicializado
    this.io = this.socketService.io; // üî• OBTENER IO
    this.pool = pool;
  }

  /**
   * @name connectDB
   * @method
   * @description Metodo para conectarme a la base de datos en la misma instancia
   * @returns
   * Devuelve la conexion con la base de datos
   */
  async connectDB() {
    if (!this.pool) {
      this.pool = pool;
      await this.pool.connect();
    }
    return this.pool;
  }

  /**
   * @name disconnectDB
   * @method
   * @description Metodo que ejecuta las desconexion de la base de datos
   */
  async disconnectDB() {
    if (this.pool) {
      await this.pool.end();
      this.pool = null;
    }
  }

  /**
   * @name searchNotificationUser
   * @description Busca las notificiones vinculadas con el usuario
   * @param {Number} user_id Id del usuario
   * @returns
   * Notificaciones que estan vinculadas con el usuario
   */
  async searchNotificationUser(user_id, options = {}) {
    try {
      const { soloNoLeidas = true, limite = 50 } = options; // ‚ùå Eliminar fechaDesde

      let query = `
      SELECT * FROM public.vista_notificaciones_completa 
      WHERE user_id = $1::bigint
    `;

      const params = [parseInt(user_id)];
      let paramCount = 1;

      // Filtro por no le√≠das
      if (soloNoLeidas) {
        paramCount++;
        query += ` AND leida = $${paramCount}::boolean`;
        params.push(false);
      }

      // ‚ùå ELIMINADO: filtro por fechaDesde
      // if (fechaDesde) {
      //   paramCount++;
      //   query += ` AND fecha_creacion > $${paramCount}::timestamp`;
      //   params.push(fechaDesde);
      // }

      // Orden y l√≠mite
      paramCount++;
      query += ` ORDER BY fecha_creacion DESC LIMIT $${paramCount}::integer`;
      params.push(limite);

      const result = await this.pool.query(query, params);
      return result.rows;
    } catch (error) {
      console.error("‚ùå Error en searchNotificationUser:", error);
      throw error;
    }
  }

  /**
   * Busca notificaciones masivas dirigidas a roles espec√≠ficos en el sistema.
   *
   * @async
   * @method searchNotificationRoles
   * @param {string[]} roles - Array de roles para filtrar las notificaciones masivas
   * @returns {Promise&lt;Array&lt;Object>>} Promesa que resuelve con un array de objetos de notificaci√≥n
   * @throws {Error} Cuando ocurre un error en la consulta a la base de datos
   *
   * @example
   * // Buscar notificaciones para roles de profesor y administrador
   * const notificaciones = await notificationService.searchNotificationRoles(['profesor', 'admin']);
   *
   * @example
   * // Si no se proporcionan roles, retorna array vac√≠o
   * const notificaciones = await notificationService.searchNotificationRoles([]);
   * // Retorna: []
   *
   * @description
   * Consulta la vista 'vista_notificaciones_completa' para obtener notificaciones masivas
   * que est√©n dirigidas a cualquiera de los roles especificados. Utiliza el operador &amp;&amp; de PostgreSQL
   * para verificar la intersecci√≥n entre arrays.
   */
  async searchNotificationRoles(roles, options = {}) {
    try {
      if (!roles || roles.length === 0) {
        return [];
      }

      const { soloNoLeidas = true, limite = 50 } = options; // ‚ùå Eliminar fechaDesde

      let query = `
      SELECT * FROM public.vista_notificaciones_completa 
      WHERE es_masiva = true 
      AND roles_destinatarios &amp;&amp; $1::varchar[]
    `;

      const params = [roles];
      let paramCount = 1;

      if (soloNoLeidas) {
        paramCount++;
        query += ` AND leida = $${paramCount}::boolean`;
        params.push(false);
      }

      // ‚ùå ELIMINADO: filtro por fechaDesde
      // if (fechaDesde) {
      //   paramCount++;
      //   query += ` AND fecha_creacion > $${paramCount}::timestamp`;
      //   params.push(fechaDesde);
      // }

      paramCount++;
      query += ` ORDER BY fecha_creacion DESC LIMIT $${paramCount}::integer`;
      params.push(limite);

      const result = await this.pool.query(query, params);
      return result.rows;
    } catch (error) {
      console.error("‚ùå Error en searchNotificationRoles:", error);
      throw error;
    }
  }

  /**
   * Busca notificaciones masivas donde el usuario espec√≠fico sea destinatario directo.
   *
   * @async
   * @method searchNotificationDestinatario
   * @param {string|number} user_id - ID del usuario para filtrar notificaciones
   * @returns {Promise&lt;Array&lt;Object>>} Promesa que resuelve con un array de objetos de notificaci√≥n
   * @throws {Error} Cuando ocurre un error en la consulta a la base de datos
   *
   * @example
   * // Buscar notificaciones para el usuario con ID 31264460
   * const notificaciones = await notificationService.searchNotificationDestinatario(31264460);
   *
   * @example
   * // Buscar notificaciones para usuario string ID
   * const notificaciones = await notificationService.searchNotificationDestinatario('user_123');
   *
   * @description
   * Consulta la vista 'vista_notificaciones_completa' para obtener notificaciones masivas
   * donde el usuario espec√≠fico est√© incluido en la lista de usuarios destinatarios.
   * Utiliza el operador ANY de PostgreSQL para verificar si el user_id est√° en el array de destinatarios.
   */
  async searchNotificationDestinatario(user_id, options = {}) {
    try {
      const { soloNoLeidas = true, limite = 50 } = options; // ‚ùå Eliminar fechaDesde

      let query = `
      SELECT * FROM public.vista_notificaciones_completa 
      WHERE es_masiva = true 
      AND $1::bigint = ANY(usuarios_destinatarios)
    `;

      const params = [parseInt(user_id)]; // Usar parseInt en lugar de toString()
      let paramCount = 1;

      if (soloNoLeidas) {
        paramCount++;
        query += ` AND leida = $${paramCount}::boolean`;
        params.push(false);
      }

      // ‚ùå ELIMINADO: filtro por fechaDesde
      // if (fechaDesde) {
      //   paramCount++;
      //   query += ` AND fecha_creacion > $${paramCount}::timestamp`;
      //   params.push(fechaDesde);
      // }

      paramCount++;
      query += ` ORDER BY fecha_creacion DESC LIMIT $${paramCount}::integer`;
      params.push(limite);

      const result = await this.pool.query(query, params);
      return result.rows;
    } catch (error) {
      console.error("‚ùå Error en searchNotificationDestinatario:", error);
      throw error;
    }
  }

  /**
   * Busca notificaciones globales (p√∫blicas) que no est√°n dirigidas a usuarios o roles espec√≠ficos.
   *
   * @async
   * @method searchNotificationGlobales
   * @returns {Promise&lt;Array&lt;Object>>} Promesa que resuelve con un array de notificaciones globales
   * @throws {Error} Cuando ocurre un error en la consulta a la base de datos
   *
   * @example
   * // Buscar todas las notificaciones globales
   * const notificacionesGlobales = await notificationService.searchNotificationGlobales();
   *
   * @description
   * Consulta la vista 'vista_notificaciones_completa' para obtener notificaciones masivas
   * que sean completamente globales, es decir:
   * - No tienen user_id asociado (user_id IS NULL)
   * - No tienen roles destinatarios definidos (roles_destinatarios = array vac√≠o)
   * - No tienen usuarios destinatarios espec√≠ficos (usuarios_destinatarios = array vac√≠o)
   *
   * Estas notificaciones son visibles para todos los usuarios del sistema.
   */
  async searchNotificationGlobales(options = {}) {
    try {
      const { soloNoLeidas = true, limite = 50 } = options;

      let query = `
      SELECT * FROM public.vista_notificaciones_completa 
      WHERE es_masiva = true 
      AND (
        -- Notificaciones realmente globales (sin destinatarios)
        (
          (roles_destinatarios IS NULL OR roles_destinatarios = '{}' OR array_length(roles_destinatarios, 1) IS NULL)
          AND
          (usuarios_destinatarios IS NULL OR usuarios_destinatarios = '{}' OR array_length(usuarios_destinatarios, 1) IS NULL)
        )
        OR
        -- üî• INCLUIR notificaciones con roles (pero sin usuarios espec√≠ficos)
        (
          array_length(roles_destinatarios, 1) > 0 
          AND 
          (usuarios_destinatarios IS NULL OR usuarios_destinatarios = '{}' OR array_length(usuarios_destinatarios, 1) IS NULL)
        )
      )
    `;

      const params = [];
      let paramCount = 0;

      if (soloNoLeidas) {
        paramCount++;
        query += ` AND leida = $${paramCount}::boolean`;
        params.push(false);
      }

      paramCount++;
      query += ` ORDER BY fecha_creacion DESC LIMIT $${paramCount}::integer`;
      params.push(limite);

      //console.log("üîç Query globales EXPANDIDA:", query);
      //console.log("üîç Par√°metros:", params);

      const result = await this.pool.query(query, params);
      //console.log(`‚úÖ Notificaciones globales expandidas encontradas: ${result.rows.length}`);

      return result.rows;
    } catch (error) {
      //console.error("‚ùå Error en searchNotificationGlobales:", error);
      throw error;
    }
  }

  /**
   * Busca todas las notificaciones relevantes para un usuario espec√≠fico bas√°ndose en sus roles y ID.
   * Combina m√∫ltiples fuentes de notificaciones y elimina duplicados.
   *
   * @async
   * @method searchNotifications
   * @param {Object} params - Par√°metros de b√∫squeda
   * @param {string[]} [params.roles=[]] - Roles del usuario para filtrar notificaciones por rol
   * @param {string|number} [params.user_id=null] - ID del usuario para filtrar notificaciones personales
   * @returns {Promise&lt;Array&lt;Object>>} Promesa que resuelve con un array combinado y √∫nico de notificaciones
   * @throws {Error} Cuando ocurre un error en alguna de las consultas a la base de datos
   *
   * @example
   * // Buscar notificaciones para un profesor con ID espec√≠fico
   * const notificaciones = await notificationService.searchNotifications({
   *   roles: ['profesor', 'coordinador'],
   *   user_id: 31264460
   * });
   *
   * @example
   * // Buscar notificaciones solo con roles (sin user_id)
   * const notificaciones = await notificationService.searchNotifications({
   *   roles: ['admin']
   * });
   *
   * @description
   * Este m√©todo realiza b√∫squedas en paralelo de 4 tipos de notificaciones:
   * 1. Notificaciones personales del usuario (searchNotificationUser)
   * 2. Notificaciones por roles del usuario (searchNotificationRoles)
   * 3. Notificaciones donde el usuario es destinatario directo (searchNotificationDestinatario)
   * 4. Notificaciones globales para todos los usuarios (searchNotificationGlobales)
   *
   * Luego combina los resultados y elimina duplicados usando un Map basado en el ID de notificaci√≥n.
   * Esto garantiza que cada notificaci√≥n aparezca solo una vez en el resultado final.
   */
  async searchNotifications({ roles = [], user_id = null, options = {} }) {
    try {
      await this.connectDB();

      // En searchNotifications, antes de las consultas
      //console.log("üîç Debug - usuario y roles:", {user_id,user_roles: roles});
      //console.log("‚öô opciones: ", options);

      const [
        notificationsUser,
        notificationsRol,
        notificationsDestinatario,
        notificationsGlobales,
      ] = await Promise.all([
        user_id ? this.searchNotificationUser(user_id, options) : [],
        roles.length > 0 ? this.searchNotificationRoles(roles, options) : [],
        user_id ? this.searchNotificationDestinatario(user_id, options) : [],
        this.searchNotificationGlobales(options),
      ]);

      // Combinar y eliminar duplicados
      const allNotificationsMap = new Map();

      [
        ...notificationsUser,
        ...notificationsRol,
        ...notificationsDestinatario,
        ...notificationsGlobales,
      ].forEach((notif) => {
        if (!allNotificationsMap.has(notif.id)) {
          allNotificationsMap.set(notif.id, notif);
        }
      });

      const allNotifications = Array.from(allNotificationsMap.values());

      // Ordenar por fecha de creaci√≥n (m√°s recientes primero)
      return allNotifications.sort(
        (a, b) => new Date(b.fecha_creacion) - new Date(a.fecha_creacion)
      );
    } catch (error) {
      //console.error("‚ùå Error en searchNotifications:", error);
      throw error;
    }
  }

  /**
   * Escucha notificaciones en tiempo real desde PostgreSQL usando LISTEN/NOTIFY.
   * Espera por nuevas notificaciones en los canales especificados hasta que ocurra un timeout.
   *
   * @async
   * @method listenNotifications
   * @param {number} [timeoutMs=30000] - Tiempo m√°ximo de espera en milisegundos (30 segundos por defecto)
   * @returns {Promise&lt;Object|null>} Promesa que resuelve con los datos de la notificaci√≥n o null si timeout
   * @throws {Error} Cuando ocurre un error en la conexi√≥n o parsing de datos
   *
   * @example
   * // Escuchar notificaciones por 30 segundos
   * const notificacion = await notificationService.listenNotifications();
   *
   * @example
   * // Escuchar notificaciones por 60 segundos
   * const notificacion = await notificationService.listenNotifications(60000);
   *
   * @description
   * Este m√©todo utiliza el sistema de LISTEN/NOTIFY de PostgreSQL para recibir notificaciones
   * en tiempo real. Se suscribe a dos canales:
   * - 'nueva_notificacion': Para notificaciones normales
   * - 'notificacion_inmediata': Para notificaciones urgentes
   *
   * Cuando llega una notificaci√≥n, se procesa y autom√°ticamente limpia los listeners y cierra la conexi√≥n.
   */
  async listenNotifications(timeoutMs = 30000) {
    return new Promise(async (resolve, reject) => {
      try {
        await this.pool.connect();

        const notificationHandler = (msg) => {
          if (
            msg.channel === "nueva_notificacion" ||
            msg.channel === "notificacion_actualizada"
          ) {
            try {
              const data = JSON.parse(msg.payload);

              // üî• AHORA data contiene TODA la estructura de la vista
              // Con el mismo formato que tus otras consultas
              console.log("üì® Notificaci√≥n en tiempo real recibida:", data);

              // Limpiar y resolver
              this.pool.removeListener("notification", notificationHandler);
              this.pool.end().catch(console.error);

              resolve(data);
            } catch (error) {
              this.pool.removeListener("notification", notificationHandler);
              this.pool.end().catch(console.error);
              reject(error);
            }
          }
        };

        this.pool.on("notification", notificationHandler);

        // Suscribirse a los canales
        await this.pool.query("LISTEN nueva_notificacion;");
        await this.pool.query("LISTEN notificacion_actualizada;");

        // Timeout
        setTimeout(() => {
          this.pool.removeListener("notification", notificationHandler);
          this.pool.end().catch(console.error);
          resolve(null);
        }, timeoutMs);
      } catch (error) {
        console.error("‚ùå Error en listenNotifications:", error);
        reject(error);
      }
    });
  }

  /**
   * Env√≠a una notificaci√≥n a un usuario espec√≠fico a trav√©s de su sala personal de Socket.io.
   *
   * @async
   * @method sendToUser
   * @param {string|number} userId - ID del usuario destinatario
   * @param {Object} notification - Objeto de notificaci√≥n a enviar
   * @param {string} notification.title - T√≠tulo de la notificaci√≥n
   * @param {string} notification.message - Mensaje de la notificaci√≥n
   * @param {any} [notification.data] - Datos adicionales de la notificaci√≥n
   *
   * @example
   * // Enviar notificaci√≥n personal a un usuario
   * await notificationService.sendToUser(31264460, {
   *   title: "Mensaje personal",
   *   message: "Tienes un nuevo mensaje",
   *   data: { messageId: 123 }
   * });
   *
   * @description
   * La notificaci√≥n se env√≠a a la sala 'user_{userId}' usando Socket.io.
   * Solo los clientes conectados del usuario espec√≠fico recibir√°n esta notificaci√≥n.
   */
  async sendToUser(userId) {
    try {
      const notification = await this.searchNotificationUser(userId);
      notification.push(await this.searchNotificationDestinatario(userId));
      // Emitir a la sala personal del usuario
      //console.log(`user_${userId} esto es su data:`, notification);
      this.io.to(`user_${userId}`).emit("new_notification", notification);

      //console.log(`üì® Notificaci√≥n enviada a usuario ${userId}`);
    } catch (error) {
      //console.error("‚ùå Error enviando notificaci√≥n a usuario:", error);
    }
  }

  /**
   * Env√≠a una notificaci√≥n a m√∫ltiples roles simult√°neamente.
   *
   * @async
   * @method sendToRoles
   * @param {string[]} roles - Array de roles destinatarios
   *
   * @example
   * // Enviar notificaci√≥n a profesores y administradores
   * await notificationService.sendToRoles(['profesor', 'admin']);
   *
   * @description
   * Itera sobre cada rol y env√≠a la notificaci√≥n a su respectiva sala.
   * Cada rol recibe la misma notificaci√≥n de forma independiente.
   */
  async sendToRoles(roles) {
    try {
      const notification = await this.searchNotificationRoles(roles);

      ////console.log("üîç Notificaci√≥n encontrada:", notification);
      ////console.log("üéØ Roles destino:", roles);

      // Usar this.socketService.io que es la instancia real del servidor
      const io = this.socketService.io;

      ////console.log("üîß Usando this.socketService.io");
      ////console.log("üîß ¬øTiene sockets?", !!io.sockets);
      ////console.log("üîß ¬øTiene adapter?", !!io.sockets?.adapter);

      roles.forEach((role) => {
        const roomName = `role_${role.toLowerCase()}`;

        // Usar io.sockets.adapter
        const room = io.sockets.adapter.rooms.get(roomName);
        const numClients = room ? room.size : 0;

        ////console.log(`üì§ Enviando a sala: ${roomName} (${numClients} clientes)`);

        // Enviar con io
        io.to(roomName).emit("new_notification", {
          success: true,
          data: notification,
          timestamp: new Date().toISOString(),
        });
      });

      ////console.log(`‚úÖ Notificaci√≥n enviada a roles: ${roles.join(", ")}`);
    } catch (error) {
      ////console.error("‚ùå Error enviando notificaci√≥n a roles:", error);
    }
  }

  /**
   * Env√≠a notificaciones globales a todos los usuarios conectados en el sistema.
   * Las notificaciones globales son aquellas que no est√°n dirigidas a usuarios o roles espec√≠ficos.
   *
   * @async
   * @method sendToGlobals
   * @returns {Promise&lt;void>} Promesa que se resuelve cuando se env√≠an las notificaciones
   * @throws {Error} Cuando ocurre un error al buscar o enviar las notificaciones globales
   *
   * @example
   * // Enviar todas las notificaciones globales a los usuarios conectados
   * await notificationService.sendToGlobals();
   *
   * @example
   * // Uso en conjunto con otros m√©todos de env√≠o
   * await notificationService.sendToGlobals();
   * await notificationService.sendToRole('admin', notificacionEspecifica);
   *
   * @description
   * Este m√©todo realiza las siguientes acciones:
   * 1. Busca todas las notificaciones globales usando searchNotificationGlobales()
   * 2. Env√≠a cada notificaci√≥n global a trav√©s del canal 'new_notification'
   * 3. Las notificaciones se env√≠an a todos los clientes conectados (this.io.emit)
   * 4. Registra en consola el n√∫mero de notificaciones globales enviadas
   *
   * Las notificaciones globales son ideales para anuncios del sistema, mantenimientos programados,
   * o informaci√≥n relevante para todos los usuarios de la plataforma.
   */
  async sendToGlobals() {
    try {
      // Obtener todas las notificaciones globales desde la base de datos
      const globalNotifications = await this.searchNotificationGlobales();

      // Enviar cada notificaci√≥n global a todos los clientes conectados
      globalNotifications.forEach((notification) => {
        this.io.emit("new_notification", {
          data: notification,
        });
      });
    } catch (error) {
      //console.error("‚ùå Error enviando notificaciones globales:", error);
      throw error;
    }
  }

  /**
   * Marca una notificaci√≥n como le√≠da para un usuario espec√≠fico.
   *
   * @async
   * @method markAsRead
   * @param {string|number} notificationId - ID de la notificaci√≥n a marcar como le√≠da.
   * @param {string|number} userId - ID del usuario que marca la notificaci√≥n como le√≠da.
   * @returns {Promise&lt;Object>} Promesa que resuelve con el estado de lectura actualizado (de notification_recipients).
   */
  async markAsRead(notificationId, userId) {
    const client = await this.connectDB();
    try {
      // ‚ùå CAMBIO CRUCIAL: La actualizaci√≥n se hace en la tabla notification_recipients.
      // Se utilizan dos condiciones: notification_id ($1) y user_id ($2).
      const result = await client.query(
        `UPDATE public.notification_recipients
             SET is_read = TRUE, read_at = NOW()
             WHERE notification_id = $1 AND user_id = $2
             RETURNING *`, // Retorna el registro de lectura actualizado
        [notificationId, userId] // Se pasan ambos IDs
      );

      if (result.rows.length > 0) {
        const updatedRecipientStatus = result.rows[0];

        // ‚úÖ Notificaci√≥n en tiempo real para el usuario espec√≠fico (o el canal de notificaciones)
        // Se emite un evento para que el cliente que hizo la acci√≥n actualice su lista
        this.io.to(`user:${userId}`).emit("notification_updated", {
          notificationId: updatedRecipientStatus.notification_id,
          userId: updatedRecipientStatus.user_id,
          is_read: true,
          read_at: updatedRecipientStatus.read_at,
          action: "marked_read",
        });

        return updatedRecipientStatus;
      } else {
        // Error si no se encontr√≥ la fila. Esto puede significar:
        // 1. La notificaci√≥n no existe.
        // 2. La notificaci√≥n existe, pero no est√° dirigida a este usuario (no hay registro en notification_recipients).
        throw new Error(
          `Estado de Notificaci√≥n ID ${notificationId} no encontrado para el Usuario ID ${userId}.`
        );
      }
    } catch (error) {
      console.error("Error en markAsRead:", error);
      throw error;
    } finally {
      // Es crucial liberar el cliente de la base de datos si usas pool.connect()
      // client.release(); // (Depende de tu implementaci√≥n de connectDB)
    }
  }

  /**
   * Crea una notificaci√≥n individual y la env√≠a en tiempo real al usuario
   */
  async crearNotificacionIndividual({
    titulo,
    tipo,
    user_id,
    contenido = null,
    metadatos = null,
  }) {
    try {
      // 1. Crear notificaci√≥n usando la funci√≥n PostgreSQL
      const result = await this.pool.query(
        `SELECT utils.registrar_notificacion($1, $2, $3, $4, $5, $6, $7) as notification_id`,
        [titulo, tipo, user_id, contenido, false, null, metadatos]
      );

      const notificationId = result.rows[0].notification_id;

      // 2. Obtener datos completos de la vista
      const notificacionCompleta = await this.pool.query(
        `SELECT * FROM vista_notificaciones_completa WHERE id = $1`,
        [notificationId]
      );

      const notificacion = notificacionCompleta.rows[0];

      if (this.io) {
        this.io.to(`user_${user_id}`).emit("new_notification", {
          success: true,
          data: [notificacion], // Mismo formato que el frontend espera
          timestamp: new Date().toISOString(),
        });
        console.log(
          `üì® Notificaci√≥n individual enviada en tiempo real a usuario ${user_id}`
        );
      }

      return notificacion;
    } catch (error) {
      console.error("‚ùå Error creando notificaci√≥n individual:", error);
      throw error;
    }
  }

  /**
   * Crea una notificaci√≥n masiva y la env√≠a en tiempo real a los roles/destinatarios
   */
  async crearNotificacionMasiva({
    titulo,
    tipo,
    contenido = null,
    metadatos = null,
    roles_ids = [],
    users_ids = [],
  }) {
    try {
      // 1. Crear notificaci√≥n masiva usando la funci√≥n PostgreSQL
      const result = await this.pool.query(
        `SELECT utils.registrar_notificacion_masiva($1, $2, $3, $4, $5, $6) as notification_id`,
        [tipo, titulo, contenido, metadatos, roles_ids, users_ids]
      );

      const notificationId = result.rows[0].notification_id;

      // 2. Obtener datos completos de la vista
      const notificacionCompleta = await this.pool.query(
        `SELECT * FROM vista_notificaciones_completa WHERE id = $1`,
        [notificationId]
      );

      const notificacion = notificacionCompleta.rows[0];

      // 3. ‚úÖ ENVIAR EN TIEMPO REAL a los destinatarios
      if (this.io) {
        // Enviar a roles
        if (
          notificacion.roles_destinatarios &amp;&amp;
          notificacion.roles_destinatarios.length > 0
        ) {
          notificacion.roles_destinatarios.forEach((role) => {
            this.io.to(`role_${role.toLowerCase()}`).emit("new_notification", {
              success: true,
              data: [notificacion],
              timestamp: new Date().toISOString(),
            });
          });
          console.log(
            `üì® Notificaci√≥n masiva enviada a roles:`,
            notificacion.roles_destinatarios
          );
        }

        // Enviar a usuarios espec√≠ficos
        if (
          notificacion.usuarios_destinatarios &amp;&amp;
          notificacion.usuarios_destinatarios.length > 0
        ) {
          notificacion.usuarios_destinatarios.forEach((userId) => {
            this.io.to(`user_${userId}`).emit("new_notification", {
              success: true,
              data: [notificacion],
              timestamp: new Date().toISOString(),
            });
          });
          console.log(
            `üì® Notificaci√≥n masiva enviada a usuarios:`,
            notificacion.usuarios_destinatarios
          );
        }
      }

      return notificacion;
    } catch (error) {
      console.error("‚ùå Error creando notificaci√≥n masiva:", error);
      throw error;
    }
  }

  /**
   * Agrega un rol destinatario a una notificaci√≥n existente y notifica en tiempo real
   */
  async agregarRolDestinatario(notification_id, role_id) {
    try {
      // 1. Registrar el rol usando la funci√≥n PostgreSQL
      await this.pool.query(`SELECT utils.registrar_rol_notificacion($1, $2)`, [
        notification_id,
        role_id,
      ]);

      // 2. Obtener notificaci√≥n actualizada
      const notificacionCompleta = await this.pool.query(
        `SELECT * FROM vista_notificaciones_completa WHERE id = $1`,
        [notification_id]
      );

      const notificacion = notificacionCompleta.rows[0];

      // 3. ‚úÖ ENVIAR EN TIEMPO REAL al nuevo rol
      if (this.io) {
        // Obtener el nombre del rol (necesitar√≠as una consulta adicional)
        const roleResult = await this.pool.query(
          `SELECT nombre_rol FROM roles WHERE id_rol = $1`,
          [role_id]
        );

        if (roleResult.rows.length > 0) {
          const roleName = roleResult.rows[0].nombre_rol;
          this.io
            .to(`role_${roleName.toLowerCase()}`)
            .emit("new_notification", {
              success: true,
              data: [notificacion],
              timestamp: new Date().toISOString(),
            });
          console.log(`üì® Notificaci√≥n enviada a nuevo rol: ${roleName}`);
        }
      }

      return notificacion;
    } catch (error) {
      console.error("‚ùå Error agregando rol destinatario:", error);
      throw error;
    }
  }

  /**
   * Agrega un usuario destinatario a una notificaci√≥n existente y notifica en tiempo real
   */
  async agregarUsuarioDestinatario(notification_id, user_id, is_read = false) {
    try {
      // 1. Registrar el destinatario usando la funci√≥n PostgreSQL
      await this.pool.query(
        `SELECT utils.registrar_destinatario_notificacion($1, $2, $3)`,
        [notification_id, user_id, is_read]
      );

      // 2. Obtener notificaci√≥n actualizada
      const notificacionCompleta = await this.pool.query(
        `SELECT * FROM vista_notificaciones_completa WHERE id = $1`,
        [notification_id]
      );

      const notificacion = notificacionCompleta.rows[0];

      // 3. ‚úÖ ENVIAR EN TIEMPO REAL al nuevo usuario
      if (this.io) {
        this.io.to(`user_${user_id}`).emit("new_notification", {
          success: true,
          data: [notificacion],
          timestamp: new Date().toISOString(),
        });
        console.log(`üì® Notificaci√≥n enviada a nuevo usuario: ${user_id}`);
      }

      return notificacion;
    } catch (error) {
      console.error("‚ùå Error agregando usuario destinatario:", error);
      throw error;
    }
  }

  /**
   * M√©todo completo para crear notificaci√≥n con destinatarios flexibles
   */
  async crearNotificacionCompleta({
    titulo,
    tipo,
    contenido = null,
    metadatos = null,
    user_id = null, // Para notificaci√≥n individual
    roles_ids = [], // Para notificaci√≥n masiva por roles
    users_ids = [], // Para notificaci√≥n masiva por usuarios
    es_masiva = false,
  }) {
    if (es_masiva) {
      return await this.crearNotificacionMasiva({
        titulo,
        tipo,
        contenido,
        metadatos,
        roles_ids,
        users_ids,
      });
    } else {
      if (!user_id) {
        throw new Error("Para notificaci√≥n individual se requiere user_id");
      }
      return await this.crearNotificacionIndividual({
        titulo,
        tipo,
        user_id,
        contenido,
        metadatos,
      });
    }
  }
}
</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 4.0.4</a> on Thu Dec 04 2025 12:35:39 GMT-0400 (hora de Venezuela) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
